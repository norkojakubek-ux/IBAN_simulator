<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prvá Cvičná Banka, a.s. — Simulátor bankovej platby</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --ink:#e5e7eb; --accent:#6366f1; }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1229,#0e162f);color:var(--ink)}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{background:rgba(17,24,39,.82);backdrop-filter:blur(6px);border:1px solid rgba(148,163,184,.18);border-radius:20px;padding:24px 24px 8px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:clamp(22px,3vw,30px);margin:0 0 8px;font-weight:800;letter-spacing:.2px}
    .sub{color:#cbd5e1;margin:2px 0 16px}
    label{display:block;font-size:13px;color:#cbd5e1;margin:14px 0 6px}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0b1224;color:#e5e7eb;outline:none;transition:.18s;border-color,.18s box-shadow;font-size:14px}
    input:focus,select:focus,textarea:focus{border-color:#7c8ae0;box-shadow:0 0 0 3px rgba(99,102,241,.2)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-size:12px;border:1px solid rgba(148,163,184,.25)}
    .pill.ok{color:#10b981;border-color:rgba(16,185,129,.35)}
    .pill.bad{color:#ef4444;border-color:rgba(239,68,68,.35)}
    .pill.warn{color:#f59e0b;border-color:rgba(245,158,11,.35)}
    .actions{display:flex;gap:10px;margin:18px 0 8px;flex-wrap:wrap}
    button{appearance:none;border:0;background:linear-gradient(180deg,#818cf8,#6366f1);color:#fff;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 12px 24px rgba(99,102,241,.35);transition:transform .06s ease, box-shadow .2s ease}
    button:hover{box-shadow:0 16px 30px rgba(99,102,241,.45)}
    button:active{transform:translateY(1px)}
    button.secondary{background:#0b1224;border:1px solid rgba(148,163,184,.25);box-shadow:none;color:#d1d5db}
    .muted{color:var(--muted)}
    .error{margin-top:6px;color:var(--err);font-size:12px;min-height:14px}
    .summary{margin-top:18px;padding:16px;border-radius:14px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.6)}
    .summary h3{margin:0 0 8px}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:6px;font-size:14px}
    .kv div{padding:6px 0;border-bottom:1px dotted rgba(148,163,184,.25)}
    .hidden{display:none}
    .foot{margin-top:8px;font-size:12px;color:#9aa7bd}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Prvá Cvičná Banka, a.s.</h1>
      <p class="sub">Simulátor bankového prevodu (len na výučbu – žiadne skutočné platby)</p>

      <form id="payForm" novalidate>
        <div class="row">
          <div>
            <label for="debtorName">Meno platiteľa</label>
            <input id="debtorName" placeholder="Meno a priezvisko" autocomplete="name" required />
          </div>
          <div>
            <label for="debtorIban">IBAN platiteľa</label>
            <input id="debtorIban" placeholder="AAxx xxxx xxxx xxxx xxxx xxxx" spellcheck="false" autocomplete="off" pattern="[A-Z0-9 ]+" required />
            <div class="error" id="debtorIbanErr"></div>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="credName">Meno príjemcu</label>
            <input id="credName" placeholder="Názov firmy / Meno a priezvisko" required />
          </div>
          <div>
            <label for="credIban">IBAN príjemcu</label>
            <input id="credIban" placeholder="AAxx xxxx xxxx xxxx xxxx xxxx" spellcheck="false" autocomplete="off" pattern="[A-Z0-9 ]+" required />
            <div class="error" id="credIbanErr"></div>
          </div>
        </div>
        <div class="row3">
          <div>
            <label for="amount">Suma (EUR)</label>
            <input id="amount" inputmode="decimal" placeholder="Suma (EUR)" required />
            <div class="error" id="amountErr"></div>
          </div>
          <div>
            <label for="execDate">Dátum vykonania</label>
            <input id="execDate" type="date" required />
            <div class="error" id="dateErr"></div>
          </div>
          <div>
            <label for="purpose">Účel platby (kód, voliteľné)</label>
            <input id="purpose" placeholder="SALA / SUPP / RENT ..." />
          </div>
        </div>
        <div class="row3">
          <div>
            <label for="vs">Variabilný symbol (voliteľné)</label>
            <input id="vs" placeholder="napr. 20251103" inputmode="numeric" autocomplete="off" />
          </div>
          <div>
            <label for="ss">Špecifický symbol (voliteľné)</label>
            <input id="ss" placeholder="do 10 číslic" inputmode="numeric" autocomplete="off" />
          </div>
          <div>
            <label for="ks">Konštantný symbol (voliteľné)</label>
            <input id="ks" placeholder="4 číslice" inputmode="numeric" autocomplete="off" />
          </div>
        </div>
        <label for="rem">Správa pre príjemcu / referencia (voliteľné)</label>
        <input id="rem" placeholder="Faktúra 2025-11-03 / VS 20251103" />
        <div class="actions">
          <button type="submit">Odoslať platbu</button>
          <button type="button" class="secondary" id="btnReset">Vymazať</button>
        </div>
        <div id="statusLine" class="pill warn hidden" aria-live="polite">Čaká sa na údaje…</div>
        <div id="summary" class="summary hidden"></div>
        <div class="foot">Pozn.: Medzery v IBANe sú len pre čitateľnosť. Toto je simulátor.</div>
      </form>
    </div>
  </div>

  <script>
    // ===== UTIL =====
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }
    function normalizeIban(iban){ return (iban||'').toUpperCase().replace(/\s+/g,''); }
    function formatIban(iban){ iban = normalizeIban(iban); return iban.replace(/(.{4})/g,'$1 ').trim(); }
    function stripDiacritics(str){ return String(str||'').normalize('NFD').replace(/[̀-ͯ]/g,''); }

    // IBAN: dĺžky a MOD97 kontrola
    const IBAN_LENGTHS = { AT:20, BE:16, BG:22, CH:21, CY:28, CZ:24, DE:22, DK:18, EE:20, ES:24, FI:18, FR:27, GB:22, GI:23, GR:27, HR:21, HU:28, IE:22, IS:26, IT:27, LT:20, LU:20, LV:21, MT:31, NL:18, NO:15, PL:28, PT:25, RO:24, SA:24, SE:24, SI:19, SK:24 };
    function ibanIsValid(iban){
      iban = normalizeIban(iban);
      if(iban.length < 4) return false;
      const cc = iban.slice(0,2);
      const len = IBAN_LENGTHS[cc];
      if(!len || iban.length !== len) return false;
      const rearranged = iban.slice(4) + iban.slice(0,4);
      const expanded = rearranged.replace(/[A-Z]/g, ch => (ch.charCodeAt(0)-55).toString());
      let remainder = 0;
      for (let i=0; i<expanded.length; i++) remainder = (remainder*10 + (expanded.charCodeAt(i)-48)) % 97;
      return remainder === 1;
    }

    // Skryté zadanie na overenie (nezobrazuje sa v UI)
    const ASSIGNMENT = (()=>{
      const cc='SK';
      const bban='05200000000012345678';
      function genIban(cc,bban){
        const rearr = bban + cc + '00';
        const expanded = rearr.replace(/[A-Z]/g, ch => (ch.charCodeAt(0)-55).toString());
        let rem = 0; for (let i=0;i<expanded.length;i++) rem = (rem*10 + (expanded.charCodeAt(i)-48)) % 97;
        const check = String(98 - rem).padStart(2,'0');
        return cc + check + bban;
      }
      return { name:'Anna Jarová', iban: genIban(cc,bban), amount:867.43, vs:'20251103' };
    })();

    document.addEventListener('DOMContentLoaded', () => {
      // Mapovanie elementov
      const f = {
        form: document.getElementById('payForm'),
        debtorName: document.getElementById('debtorName'),
        debtorIban: document.getElementById('debtorIban'),
        credName: document.getElementById('credName'),
        credIban: document.getElementById('credIban'),
        amount: document.getElementById('amount'),
        execDate: document.getElementById('execDate'),
        purpose: document.getElementById('purpose'),
        vs: document.getElementById('vs'),
        ss: document.getElementById('ss'),
        ks: document.getElementById('ks'),
        rem: document.getElementById('rem'),
        status: document.getElementById('statusLine'),
        sum: document.getElementById('summary'),
        err: {
          debtorIban: document.getElementById('debtorIbanErr'),
          credIban: document.getElementById('credIbanErr'),
          amount: document.getElementById('amountErr'),
          date: document.getElementById('dateErr'),
        }
      };

      // Init: dnešný dátum
      const today = new Date();
      f.execDate.valueAsDate = today;
      f.execDate.min = today.toISOString().slice(0,10);

      // Živé formátovanie IBAN + jemná validácia (hlášku ukáž až keď je dĺžka kompletná)
      [f.debtorIban, f.credIban].forEach(el => {
        el.addEventListener('input', () => {
          const raw = normalizeIban(el.value);
          el.value = formatIban(raw);
          const need = IBAN_LENGTHS[raw.slice(0,2)];
          const ready = need && raw.length === need;
          const ok = raw.length===0 || (ready && ibanIsValid(raw));
          const errEl = (el===f.debtorIban)? f.err.debtorIban : f.err.credIban;
          if (errEl) errEl.textContent = ok? '' : (ready? 'Neplatný IBAN (kontrolné číslice).' : '');
        });
      });

      // Suma: prijmi čiarku aj bodku, validuj formát
      f.amount.addEventListener('input', () => {
        const v = f.amount.value.replace(',', '.');
        f.amount.value = v;
        const ok = /^\d{1,9}(\.\d{1,2})?$/.test(v) && parseFloat(v)>0;
        if (f.err.amount) f.err.amount.textContent = v && !ok ? 'Zadajte kladnú sumu, max 2 desatinné miesta.' : '';
      });

      // VS/SS/KS len číslice (KS max 4, ostatné 10)
      [f.vs, f.ss, f.ks].forEach((el,i)=>{
        el.addEventListener('input',()=>{
          el.value = el.value.replace(/\D+/g,'').slice(0, i===2?4:10);
        });
      });

      // Reset
      document.getElementById('btnReset').addEventListener('click', ()=>{
        f.form.reset();
        f.sum.classList.add('hidden');
        f.status.classList.add('hidden');
        Object.values(f.err).forEach(el=>{ if(el) el.textContent=''; });
        const t = new Date(); f.execDate.valueAsDate=t; f.execDate.min=t.toISOString().slice(0,10);
      });

      // Submit
      f.form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const data = {
          debtorName: f.debtorName.value.trim() || '— neuvedené —',
          debtorIban: normalizeIban(f.debtorIban.value),
          credName: f.credName.value.trim() || '— neuvedené —',
          credIban: normalizeIban(f.credIban.value),
          amount: parseFloat((f.amount.value||'').replace(',','.')),
          date: f.execDate.value,
          purpose: (f.purpose.value.trim()||'—'),
          vs: f.vs.value.trim(),
          ss: f.ss.value.trim(),
          ks: f.ks.value.trim(),
          rem: f.rem.value.trim() || '—'
        };

        let ok = true;
        if(!ibanIsValid(data.debtorIban)){ if(f.err.debtorIban) f.err.debtorIban.textContent='Neplatný IBAN.'; ok=false; } else if(f.err.debtorIban) f.err.debtorIban.textContent='';
        if(!ibanIsValid(data.credIban)){ if(f.err.credIban) f.err.credIban.textContent='Neplatný IBAN.'; ok=false; } else if(f.err.credIban) f.err.credIban.textContent='';
        if(!(data.amount>0) || !/^\d{1,9}(\.\d{1,2})?$/.test(String((f.amount.value||'').replace(',','.')))){
          if(f.err.amount) f.err.amount.textContent='Zadajte kladnú sumu, max 2 desatinné miesta.'; ok=false; 
        } else if(f.err.amount) f.err.amount.textContent='';
        const todayStr = new Date().toISOString().slice(0,10);
        if(!data.date || data.date < todayStr){ if(f.err.date) f.err.date.textContent='Zvoľte dnešný alebo budúci deň.'; ok=false; } else if(f.err.date) f.err.date.textContent='';

        if(!ok){
          f.status.textContent='Opravte zvýraznené polia.';
          f.status.className='pill bad';
          f.status.classList.remove('hidden');
          return;
        }

        const flags = [];
        if(data.amount >= 10000) flags.push('Platba vyššej hodnoty (manuálna kontrola).');
        if(/krypto|bitcoin|daruj|gift/i.test(data.rem)) flags.push('Správa obsahuje rizikové kľúčové slová.');

        // Overenie voči skrytému zadaniu (bez zverejnenia správnych hodnôt)
        const nameOk = stripDiacritics(data.credName).toUpperCase() === stripDiacritics(ASSIGNMENT.name).toUpperCase();
        const ibanOk = normalizeIban(data.credIban) === ASSIGNMENT.iban;
        const amtOk  = Math.abs((data.amount||0) - ASSIGNMENT.amount) < 0.005;
        const vsOk   = (data.vs||'') === ASSIGNMENT.vs;
        const allOk = nameOk && ibanOk && amtOk && vsOk;
        const badge = allOk ? '<span class="pill ok">SÚHLASÍ SO ZADANÍM</span>' : '<span class="pill bad">NESEDÍ SO ZADANÍM</span>';
        const diffs = [];
        if(!nameOk) diffs.push('Meno príjemcu – nesedí so zadaním.');
        if(!ibanOk) diffs.push('IBAN príjemcu – nesedí so zadaním.');
        if(!amtOk)  diffs.push('Suma – nesedí so zadaním.');
        if(!vsOk)   diffs.push('Variabilný symbol – nesedí so zadaním.');

        const html = `
          <h3>Príkaz na úhradu ${badge}</h3>
          <div class="kv">
            <div>Platiteľ</div><div>${escapeHtml(data.debtorName)} — ${formatIban(data.debtorIban)}</div>
            <div>Príjemca</div><div>${escapeHtml(data.credName)} — ${formatIban(data.credIban)}</div>
            <div>Suma</div><div><strong>${data.amount.toFixed(2)} EUR</strong></div>
            <div>Dátum vykonania</div><div>${data.date}</div>
            <div>Účel platby</div><div>${escapeHtml(data.purpose||'—')}</div>
            <div>Variabilný symbol</div><div>${escapeHtml(data.vs||'—')}</div>
            <div>Špecifický symbol</div><div>${escapeHtml(data.ss||'—')}</div>
            <div>Konštantný symbol</div><div>${escapeHtml(data.ks||'—')}</div>
            <div>Správa pre príjemcu</div><div>${escapeHtml(data.rem||'—')}</div>
          </div>
          ${diffs.length? `<div class="summary" style="margin-top:12px"><strong>Porovnanie so zadaním:</strong><ul>${diffs.map(d=>`<li>${d}</li>`).join('')}</ul></div>` : ''}
          ${flags.length? `<p class="muted" style="margin-top:10px">⚠ ${flags.join(' ')}</p>`:''}
          <p class="muted" style="margin-top:10px">SEPA simulátor – žiadne peniaze sa v skutočnosti neposielajú.</p>
        `;
        f.sum.innerHTML = html;
        f.sum.classList.remove('hidden');
        f.status.textContent = flags.length? 'Platba prijatá – čaká na kontrolu.' : 'Platba prijatá.';
        f.status.className = 'pill ' + (flags.length? 'warn':'ok');
        f.status.classList.remove('hidden');
      });

      // ===== Minimal self-tests (console only; bez UI) =====
      (function selfTests(){
        try {
          // 1) Validácia IBAN: vygeneruj platný SK IBAN z BBAN a over
          const genValid = (function(){
            function genIban(cc,bban){
              const rearr = bban + cc + '00';
              const expanded = rearr.replace(/[A-Z]/g, ch => (ch.charCodeAt(0)-55).toString());
              let rem = 0; for (let i=0;i<expanded.length;i++) rem = (rem*10 + (expanded.charCodeAt(i)-48)) % 97;
              const check = String(98 - rem).padStart(2,'0');
              return cc + check + bban;
            }
            const bban = '11110000000098765432';
            const iban = genIban('SK', bban);
            console.assert(ibanIsValid(iban) && iban.length===IBAN_LENGTHS['SK'], 'Test IBAN valid failed');
            // zmeň posledný znak → musí byť neplatný
            const bad = iban.slice(0,-1) + ((parseInt(iban.slice(-1)) + 1) % 10);
            console.assert(!ibanIsValid(bad), 'Test IBAN invalid failed');
          })();
          // 2) Regulár sumy
          console.assert(/^\d{1,9}(\.\d{1,2})?$/.test('1234.50'), 'Amount regex fail 1234.50');
          console.assert(!/^\d{1,9}(\.\d{1,2})?$/.test('12.345'), 'Amount regex should fail 12.345');
          console.log('[SEPA simulátor] self-tests OK');
        } catch(e){ console.warn('[SEPA simulátor] self-tests FAILED:', e); }
      })();
    });
  </script>
</body>
</html>
